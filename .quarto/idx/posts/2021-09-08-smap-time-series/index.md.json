{"title":"SMAP Time Series","markdown":{"yaml":{"title":"SMAP Time Series","date":"2021-09-08","slug":"smap-time-series","categories":["Remote Sensing"],"tags":[],"subtitle":"","description":"We perform time-series analysis of soil moisture derived from SMAP L3 product for Bengaluru city.","authors":[],"lastmod":"2021-09-08T18:43:06+05:30","featured":"no","url_code":"https://github.com/amanbagrecha/smap_time_series_analysis"},"headingText":"Overview","containsRefs":false,"markdown":"\n\n\n\nFarmers in parts of India still rely on groundwater for irrigation. For them to help understand the present condition of their farm, NASA’s Soil Moisture Active Passive (**SMAP**) satellite data could fill a significant void.\n\nThe mission collects the kind of local data agricultural and water managers worldwide need.\n\nThe main output of this data set is **surface soil moisture** (SSM)(representing approximately the top 5 cm of the soil column on average, given in cm3 /cm3 ) presented on the global 36 km EASE-Grid 2.0. While there are other measurements, we are only restricting ourselves to SSM\n\nThe SSM product has three main levels. L1, L2, and the latest being L3. SMAP uses a radiometer to detect microwave signals and process to obtain soil moisture. It initially had radar onboard but failed in 2015. Although the product is primarily available in 36 km resolution, with the help of Sentinel-1 Radar product, we now have access to 9 km resolution daily global product as well post 2016.\n\nWe are going to work with a 36 km product since a time-series can be computationally intensive to download.\n\nOne such product is **L3_SM_P**, a daily global product, which is an abbreviation of L3 soil moisture 36 km resolution.\n\nWe choose Bengaluru as our area of interest and perform the following three steps in sequence\n\n- Download the SMAP L3 data for the latest one month ( **August 2021** here).\n\n- Extraction of the soil moisture values from SMAP L3 data over Lat, Lon of Bengaluru in python.\n\n- Plot the time series plot for the extracted soil moisture values for the latest one month.\n\nTo download the SMAP L3 data, we head over to https://nsidc.org/data/SPL3SMP/versions/7 and select a time-period ( in our case for the entire month of August 2021) under the download tab. We then click on the download script button as a python file.\n\n<figure>\n\n ![](https://i.imgur.com/aoKJnay.jpg)\n\n<figcaption align = \"center\"><b><i>Fig.1 -Downloading python script for the month of August from NSIDC</i></b></figcaption>\n\n</figure>\n\n \nAs can be seen in the picture, we have a download size of 980 mb once we run the python script.\nThe next step would be to download the actual files and extract soil moisture value for the selected lat long.\nOne thing to note is, since the product has a resolution of 36 km and that the entire pixel represents one value, we have to couple together a set of pixels around Bengaluru since the entire region does not overlay in one pixel size.\n\nWe would be using colaboratory in this entire process since it allows for smooth use of the command line within the notebook itself.\n\n### Run the downloaded script. It will ask you for your earth data credentials (username and password)\n\nWe move the downloaded files to data directory and delete any associated files that comes along with it.\n\n```python\n# Download data: Enter credentials for earth data\n%run /content/download_SPL3.py\n \n# move files to data dir\n!mkdir -p data/L3_SM_P\n!mv *h5 data/L3_SM_P\n!rm *.h5*\n \n```\nNext, get the lat long for EASE grid 2.0. Since we have to locate Bengaluru (study area) and SMAP uses a specific grid system, we download these files.\n```python\n!wget https://github.com/nsidc/smap_python_notebooks/raw/main/notebooks/EASE2_M36km.lats.964x406x1.double\n!wget https://github.com/nsidc/smap_python_notebooks/raw/main/notebooks/EASE2_M36km.lons.964x406x1.double\n```\n \n### Extract soil moisture\n\nWe define a python class since there are two half-orbit passes (ascending and descending pass) and we could later combine them easily. \n\nWe create a `read_SML3P` method which reads the hdf5 files using the h5py library as an array and removes noisy elements as defined by the user guide. The filename contains the date of acquisition and we extract that.\n\nWe next define the `generate_time_series` method to subset the array to our area of interest (Bengaluru) while also taking the mean since there might be more than 1 pixel intersecting the AOI and then return a dataframe with date and the value of Soil Moisture.\n\nThere are some additional method we define to run and initialise the class which can be read from [here](https://github.com/amanbagrecha/smap_time_series_analysis/blob/main/main.py)\n \n```python\nclass SML3PSoilMoist:\n  \"\"\"\n  get soil moisture from L3 SMAP SCA-V algo for the specified date\n  Parameters\n  ----------\n  soil_moisture: numpy.array\n  flag_id:  [str] Quality flag of retrieved soil moisture using SCA-V\n  var_id: [str] can be replaced with scva algorithm which is the default (baseline)\n  group_id: [str] retrive soil moisture for Ascending or descending pass\n  file_list: [list] of downloaded files; File path of a SMAP L3 HDF5 file\n  -------\n  Returns Soil moisture values and time period as a DataFrame\n  \"\"\"\n \n  def __init__(self, file_list : 'list', orbit_pass: 'str'):\n    \n    ...\n \n  def run_(self):\n    \"\"\"read files and return 3d array and time\"\"\"\n    ...\n \n \n  def read_SML3P(self, filepath):\n    ''' This function extracts soil moisture from SMAP L3 P HDF5 file.\n    # refer to https://nsidc.org/support/faq/how-do-i-interpret-surface-and-quality-flag-information-level-2-and-3-passive-soil\n\n    '''    \n    with h5py.File(filepath, 'r') as f:\n \n        group_id = self.group_id \n        flag_id = self.flag_id\n        var_id = self.var_id\n \n        flag = f[group_id][flag_id][:,:]\n \n        soil_moisture = f[group_id][var_id][:,:]        \n        soil_moisture[soil_moisture==-9999.0]=np.nan;\n        soil_moisture[(flag>>0)&1==1]=np.nan # set to nan expect for 0 and even bits\n \n        filename = os.path.basename(filepath)\n        \n        yyyymmdd= filename.split('_')[4]\n        yyyy = int(yyyymmdd[0:4]); mm = int(yyyymmdd[4:6]); dd = int(yyyymmdd[6:8])\n        date=dt.datetime(yyyy,mm,dd)\n \n    return soil_moisture, date\n \n  def generate_time_series(self, bbox: 'list -> [N_lat, S_lat, W_lon, E_lon]'):\n    \n    N_lat, S_lat, W_lon, E_lon = bbox\n    subset = (lats<N_lat)&(lats>S_lat)&(lons>W_lon)&(lons<E_lon)\n    sm_time = np.empty([self.time_period]);\n    \n    sm_data_3d, times = self.run_()\n    for i in np.arange(0,self.time_period):\n        sm_2d = sm_data_3d[:,:,i]\n        \n        sm_time[i] = np.nanmean(sm_2d[subset]);\n \n    return pd.DataFrame({'time' : times, self.orbit_pass: sm_time })\n```\n\nLastly, we plot the dataframe using pandas method `plot` and the result is to be shown to the world.\n\n![](https://i.imgur.com/PngGsda.png)\n\nThis blog helps demonstrates use of SMAP product to generate time series for an entire month of August. You can read more about the specification of the product [here](https://nsidc.org/support/faq/how-do-i-interpret-surface-and-quality-flag-information-level-2-and-3-passive-soil)\n\n> Data courtesy: O'Neill et al. doi: https://doi.org/10.5067/HH4SZ2PXSP6A. [31st August, 2021].\n\n","srcMarkdownNoYaml":"\n\n\n## Overview\n\nFarmers in parts of India still rely on groundwater for irrigation. For them to help understand the present condition of their farm, NASA’s Soil Moisture Active Passive (**SMAP**) satellite data could fill a significant void.\n\nThe mission collects the kind of local data agricultural and water managers worldwide need.\n\nThe main output of this data set is **surface soil moisture** (SSM)(representing approximately the top 5 cm of the soil column on average, given in cm3 /cm3 ) presented on the global 36 km EASE-Grid 2.0. While there are other measurements, we are only restricting ourselves to SSM\n\nThe SSM product has three main levels. L1, L2, and the latest being L3. SMAP uses a radiometer to detect microwave signals and process to obtain soil moisture. It initially had radar onboard but failed in 2015. Although the product is primarily available in 36 km resolution, with the help of Sentinel-1 Radar product, we now have access to 9 km resolution daily global product as well post 2016.\n\nWe are going to work with a 36 km product since a time-series can be computationally intensive to download.\n\nOne such product is **L3_SM_P**, a daily global product, which is an abbreviation of L3 soil moisture 36 km resolution.\n\nWe choose Bengaluru as our area of interest and perform the following three steps in sequence\n\n- Download the SMAP L3 data for the latest one month ( **August 2021** here).\n\n- Extraction of the soil moisture values from SMAP L3 data over Lat, Lon of Bengaluru in python.\n\n- Plot the time series plot for the extracted soil moisture values for the latest one month.\n\nTo download the SMAP L3 data, we head over to https://nsidc.org/data/SPL3SMP/versions/7 and select a time-period ( in our case for the entire month of August 2021) under the download tab. We then click on the download script button as a python file.\n\n<figure>\n\n ![](https://i.imgur.com/aoKJnay.jpg)\n\n<figcaption align = \"center\"><b><i>Fig.1 -Downloading python script for the month of August from NSIDC</i></b></figcaption>\n\n</figure>\n\n \nAs can be seen in the picture, we have a download size of 980 mb once we run the python script.\nThe next step would be to download the actual files and extract soil moisture value for the selected lat long.\nOne thing to note is, since the product has a resolution of 36 km and that the entire pixel represents one value, we have to couple together a set of pixels around Bengaluru since the entire region does not overlay in one pixel size.\n\nWe would be using colaboratory in this entire process since it allows for smooth use of the command line within the notebook itself.\n\n### Run the downloaded script. It will ask you for your earth data credentials (username and password)\n\nWe move the downloaded files to data directory and delete any associated files that comes along with it.\n\n```python\n# Download data: Enter credentials for earth data\n%run /content/download_SPL3.py\n \n# move files to data dir\n!mkdir -p data/L3_SM_P\n!mv *h5 data/L3_SM_P\n!rm *.h5*\n \n```\nNext, get the lat long for EASE grid 2.0. Since we have to locate Bengaluru (study area) and SMAP uses a specific grid system, we download these files.\n```python\n!wget https://github.com/nsidc/smap_python_notebooks/raw/main/notebooks/EASE2_M36km.lats.964x406x1.double\n!wget https://github.com/nsidc/smap_python_notebooks/raw/main/notebooks/EASE2_M36km.lons.964x406x1.double\n```\n \n### Extract soil moisture\n\nWe define a python class since there are two half-orbit passes (ascending and descending pass) and we could later combine them easily. \n\nWe create a `read_SML3P` method which reads the hdf5 files using the h5py library as an array and removes noisy elements as defined by the user guide. The filename contains the date of acquisition and we extract that.\n\nWe next define the `generate_time_series` method to subset the array to our area of interest (Bengaluru) while also taking the mean since there might be more than 1 pixel intersecting the AOI and then return a dataframe with date and the value of Soil Moisture.\n\nThere are some additional method we define to run and initialise the class which can be read from [here](https://github.com/amanbagrecha/smap_time_series_analysis/blob/main/main.py)\n \n```python\nclass SML3PSoilMoist:\n  \"\"\"\n  get soil moisture from L3 SMAP SCA-V algo for the specified date\n  Parameters\n  ----------\n  soil_moisture: numpy.array\n  flag_id:  [str] Quality flag of retrieved soil moisture using SCA-V\n  var_id: [str] can be replaced with scva algorithm which is the default (baseline)\n  group_id: [str] retrive soil moisture for Ascending or descending pass\n  file_list: [list] of downloaded files; File path of a SMAP L3 HDF5 file\n  -------\n  Returns Soil moisture values and time period as a DataFrame\n  \"\"\"\n \n  def __init__(self, file_list : 'list', orbit_pass: 'str'):\n    \n    ...\n \n  def run_(self):\n    \"\"\"read files and return 3d array and time\"\"\"\n    ...\n \n \n  def read_SML3P(self, filepath):\n    ''' This function extracts soil moisture from SMAP L3 P HDF5 file.\n    # refer to https://nsidc.org/support/faq/how-do-i-interpret-surface-and-quality-flag-information-level-2-and-3-passive-soil\n\n    '''    \n    with h5py.File(filepath, 'r') as f:\n \n        group_id = self.group_id \n        flag_id = self.flag_id\n        var_id = self.var_id\n \n        flag = f[group_id][flag_id][:,:]\n \n        soil_moisture = f[group_id][var_id][:,:]        \n        soil_moisture[soil_moisture==-9999.0]=np.nan;\n        soil_moisture[(flag>>0)&1==1]=np.nan # set to nan expect for 0 and even bits\n \n        filename = os.path.basename(filepath)\n        \n        yyyymmdd= filename.split('_')[4]\n        yyyy = int(yyyymmdd[0:4]); mm = int(yyyymmdd[4:6]); dd = int(yyyymmdd[6:8])\n        date=dt.datetime(yyyy,mm,dd)\n \n    return soil_moisture, date\n \n  def generate_time_series(self, bbox: 'list -> [N_lat, S_lat, W_lon, E_lon]'):\n    \n    N_lat, S_lat, W_lon, E_lon = bbox\n    subset = (lats<N_lat)&(lats>S_lat)&(lons>W_lon)&(lons<E_lon)\n    sm_time = np.empty([self.time_period]);\n    \n    sm_data_3d, times = self.run_()\n    for i in np.arange(0,self.time_period):\n        sm_2d = sm_data_3d[:,:,i]\n        \n        sm_time[i] = np.nanmean(sm_2d[subset]);\n \n    return pd.DataFrame({'time' : times, self.orbit_pass: sm_time })\n```\n\nLastly, we plot the dataframe using pandas method `plot` and the result is to be shown to the world.\n\n![](https://i.imgur.com/PngGsda.png)\n\nThis blog helps demonstrates use of SMAP product to generate time series for an entire month of August. You can read more about the specification of the product [here](https://nsidc.org/support/faq/how-do-i-interpret-surface-and-quality-flag-information-level-2-and-3-passive-soil)\n\n> Data courtesy: O'Neill et al. doi: https://doi.org/10.5067/HH4SZ2PXSP6A. [31st August, 2021].\n\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"paged","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"markdown"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"wrap","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true,"format-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["../../_variables.scss"],"toc":true,"output-file":"index.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items"},"metadata":{"lang":"en-GB","fig-responsive":true,"quarto-version":"1.3.450","theme":["sandstone"],"page-layout":"article","fontsize":"1.1em","linestretch":1.7,"fontcolor":"black","author":[{"id":"cvc","number":1,"name":{"given":"Aman","family":"Bagrecha","literal":"Aman Bagrecha","non-dropping-particle":"von"},"orcid":"0000-0003-3131-0864","email":"jainaman588@gmail.com"}],"mermaid":{"theme":"neutral"},"title":"SMAP Time Series","date":"2021-09-08","slug":"smap-time-series","categories":["Remote Sensing"],"tags":[],"subtitle":"","description":"We perform time-series analysis of soil moisture derived from SMAP L3 product for Bengaluru city.","authors":[],"lastmod":"2021-09-08T18:43:06+05:30","featured":"no","url_code":"https://github.com/amanbagrecha/smap_time_series_analysis"},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}