{"title":"Two ways to Programmatically change projection of raw CSV","markdown":{"yaml":{"title":"Two ways to Programmatically change projection of raw CSV","date":"2021-09-30","slug":"two-ways-to-change-projection-of-raw-csv","categories":["GDAL","Python"],"tags":["GDAL","Python"],"subtitle":"","description":"Change projection of CSV on-the-fly using GDAL, GeoPandas","lastmod":"2021-10-10T18:42:47+05:30","featured":"no","projects":[]},"headingText":"Reproject CSV using `ogr2ogr`","containsRefs":false,"markdown":"\n\nOften, field values are collected in the Geographic Coordinate Reference System as CSV or ASCII so that it can be universally used. But when you want to perform any kind of analysis on these values, there is a need to reproject them into a Projected Coordinate Reference System for the specific area. Although there are many ways that exist now with desktop GIS, these methods can be cumbersome if you have thousands of files to reproject. \n\nThis task of reprojecting raw CSV can be accomplished using GDAL although it is not straightforward. It requires an indication of geographic data of a CSV file which is provided using VRT (GDAL virtual Raster). More advanced tools now exist which are either built on top of GDAL or are very similar. **GeoPandas** and **pyproj** are two such libraries which can help us reproject our raw CSV on-the-fly.\n\nWe first look at how this task can be accomplished using the GDAL command line.\n\n\n<figure>\n\n![](https://i.imgur.com/Udf4gdV.png)\n<figcaption align = \"center\"><b><i>Fig.1 — Raw <b style=\"color:red;\">input.csv</b> with <b>lat</b> & <b>lon</b> geometry column </i></b></figcaption>\n\n</figure>\n\nThis example shows using `ogr2ogr` to reproject the CRS of CSV file with the latitude, longitude coordinates stored as columns **lat**, **lon** in the `input.csv` file.\n```sh\nogr2ogr -f CSV -lco GEOMETRY=AS_XY -t_srs EPSG:32644 output.csv input.vrt\n```\nFollowing is the explanation of the above command,\n\n  1. `-lco GEOMETRY=AS_XY` : Layer creation option with XY columns added in output CSV.\n  2. `input.vrt` : Input Virtual Raster file containing information about CSV and its geometry.\n  3. `-t_srs EPSG:32644` : Set target CRS to EPSG:32644\n  4. `-f CSV` : specify the output file format\n  5. `output.csv` : output CSV with reprojected coordinates\n\nIn the above code, `input.vrt` is a GDAL virtual raster which has to be created prior to running the command. It points to the CSV file which has the location data stored as columns (lon, lat)\n\n```xml\n<!--input.vrt pointing to the input.csv-->\n<OGRVRTDataSource> \n  <OGRVRTLayer name=\"input\"> \n    <SrcDataSource>input.csv</SrcDataSource> \n    <GeometryType>wkbPoint</GeometryType> \n    <LayerSRS>EPSG:4326</LayerSRS> \n    <GeometryField encoding=\"PointFromColumns\" x=\"lon\" y=\"lat\"/> \n  </OGRVRTLayer> \n</OGRVRTDataSource>\n```\n\n**But what does the above xml mean?**\n\nThe above xml is a virtual raster (VRT) which allows for lazy processing. Often, we have to save intermediary outputs on our local disk, which could potentially take a lot of space. To avoid that, VRT allows to store the processing in an xml encoding and performs all intermediary action at once, in the final step. \n\n  1. The first line `<OGRVRTDataSource>` is the root element. \n  2. `<OGRVRTLayer name=\"input\">` corresponds with the `<SrcDataSource> input.csv </SrcDataSource>` and points to the `input.csv` file we want to reproject. \n  3. `<LayerSRS>EPSG:4326</LayerSRS>` specifies the CRS of our `input.csv` file. \n  4. `<GeometryType> wkbPoint </GeometryType>` is the format that coordinates are stored in. \n  5. Lastly, `<GeometryField encoding=\"PointFromColumns\" x=\"lon\" y=\"lat\"/>` indicates the columns corresponding to lon and lat in csv. Read more about converting CSV to VRT [here](https://gdal.org/drivers/vector/csv.html#reading-csv-containing-spatial-information).\n\n<figure>\n\n![](https://i.imgur.com/HefHXvu.png)\n<figcaption align = \"center\"><b><i>Fig.2 — Reprojecting CSV from EPSG:4326 to EPSG:32644 using GDAL </i></b></figcaption>\n\n</figure>\n\n\nHence, by running the above GDAL command, we would be able to reproject our CSV. By writing a bash script, this method can be scaled to thousands of files. But the intermediary `VRT` file is messy to handle and it would be nice to avoid it. Luckily for us, there are libraries built on top of GDAL which would help us avoid the hassle of creating intermediary files.\n\n\n## Using GeoPandas\n\nWith its simple and intuitive API, GeoPandas allows us to read, reproject CRS and write files on-the-fly. \n\n```python\nin_path = './'\nout_path = './output'\nfiles= [f for f in os.listdir(in_path) if f.endswith('.csv')]\ninput_crs = 'EPSG:4326'\noutput_crs = 'EPSG:32644'\n\nif not os.path.exists(out_path):\n    os.mkdir(out_path)\n\nfor file in files:\n    df = pd.read_csv(file, header=None)\n    gdf = gpd.GeoDataFrame(\n        df, crs=input_crs , geometry=gpd.points_from_xy(df.iloc[:,0], df.iloc[:,1]))\n\n    gdf.to_crs(output_crs, inplace=True)\n    gdf.iloc[:,0] = gdf.geometry.x # replace x\n    gdf.iloc[:,1] = gdf.geometry.y # replace y\n    \n    # export reprojected csv \n    gdf.iloc[:,:-1].to_csv(os.path.join(out_path, file), index=False )\n```\n\nIn the above code, we loop through our CSV files. For each file, we create a GeoDataFrame and change the CRS. Lastly, we replace the coordinates with reprojected one. \n\n### Endnote\n\nThere is another way I found by using **pyproj** library which is quite verbose but performs reprojection on-the-fly. To read about the **pyproj** method, refer [here](https://gis.stackexchange.com/a/168496).\n\n","srcMarkdownNoYaml":"\n\nOften, field values are collected in the Geographic Coordinate Reference System as CSV or ASCII so that it can be universally used. But when you want to perform any kind of analysis on these values, there is a need to reproject them into a Projected Coordinate Reference System for the specific area. Although there are many ways that exist now with desktop GIS, these methods can be cumbersome if you have thousands of files to reproject. \n\nThis task of reprojecting raw CSV can be accomplished using GDAL although it is not straightforward. It requires an indication of geographic data of a CSV file which is provided using VRT (GDAL virtual Raster). More advanced tools now exist which are either built on top of GDAL or are very similar. **GeoPandas** and **pyproj** are two such libraries which can help us reproject our raw CSV on-the-fly.\n\nWe first look at how this task can be accomplished using the GDAL command line.\n\n### Reproject CSV using `ogr2ogr`\n\n<figure>\n\n![](https://i.imgur.com/Udf4gdV.png)\n<figcaption align = \"center\"><b><i>Fig.1 — Raw <b style=\"color:red;\">input.csv</b> with <b>lat</b> & <b>lon</b> geometry column </i></b></figcaption>\n\n</figure>\n\nThis example shows using `ogr2ogr` to reproject the CRS of CSV file with the latitude, longitude coordinates stored as columns **lat**, **lon** in the `input.csv` file.\n```sh\nogr2ogr -f CSV -lco GEOMETRY=AS_XY -t_srs EPSG:32644 output.csv input.vrt\n```\nFollowing is the explanation of the above command,\n\n  1. `-lco GEOMETRY=AS_XY` : Layer creation option with XY columns added in output CSV.\n  2. `input.vrt` : Input Virtual Raster file containing information about CSV and its geometry.\n  3. `-t_srs EPSG:32644` : Set target CRS to EPSG:32644\n  4. `-f CSV` : specify the output file format\n  5. `output.csv` : output CSV with reprojected coordinates\n\nIn the above code, `input.vrt` is a GDAL virtual raster which has to be created prior to running the command. It points to the CSV file which has the location data stored as columns (lon, lat)\n\n```xml\n<!--input.vrt pointing to the input.csv-->\n<OGRVRTDataSource> \n  <OGRVRTLayer name=\"input\"> \n    <SrcDataSource>input.csv</SrcDataSource> \n    <GeometryType>wkbPoint</GeometryType> \n    <LayerSRS>EPSG:4326</LayerSRS> \n    <GeometryField encoding=\"PointFromColumns\" x=\"lon\" y=\"lat\"/> \n  </OGRVRTLayer> \n</OGRVRTDataSource>\n```\n\n**But what does the above xml mean?**\n\nThe above xml is a virtual raster (VRT) which allows for lazy processing. Often, we have to save intermediary outputs on our local disk, which could potentially take a lot of space. To avoid that, VRT allows to store the processing in an xml encoding and performs all intermediary action at once, in the final step. \n\n  1. The first line `<OGRVRTDataSource>` is the root element. \n  2. `<OGRVRTLayer name=\"input\">` corresponds with the `<SrcDataSource> input.csv </SrcDataSource>` and points to the `input.csv` file we want to reproject. \n  3. `<LayerSRS>EPSG:4326</LayerSRS>` specifies the CRS of our `input.csv` file. \n  4. `<GeometryType> wkbPoint </GeometryType>` is the format that coordinates are stored in. \n  5. Lastly, `<GeometryField encoding=\"PointFromColumns\" x=\"lon\" y=\"lat\"/>` indicates the columns corresponding to lon and lat in csv. Read more about converting CSV to VRT [here](https://gdal.org/drivers/vector/csv.html#reading-csv-containing-spatial-information).\n\n<figure>\n\n![](https://i.imgur.com/HefHXvu.png)\n<figcaption align = \"center\"><b><i>Fig.2 — Reprojecting CSV from EPSG:4326 to EPSG:32644 using GDAL </i></b></figcaption>\n\n</figure>\n\n\nHence, by running the above GDAL command, we would be able to reproject our CSV. By writing a bash script, this method can be scaled to thousands of files. But the intermediary `VRT` file is messy to handle and it would be nice to avoid it. Luckily for us, there are libraries built on top of GDAL which would help us avoid the hassle of creating intermediary files.\n\n\n## Using GeoPandas\n\nWith its simple and intuitive API, GeoPandas allows us to read, reproject CRS and write files on-the-fly. \n\n```python\nin_path = './'\nout_path = './output'\nfiles= [f for f in os.listdir(in_path) if f.endswith('.csv')]\ninput_crs = 'EPSG:4326'\noutput_crs = 'EPSG:32644'\n\nif not os.path.exists(out_path):\n    os.mkdir(out_path)\n\nfor file in files:\n    df = pd.read_csv(file, header=None)\n    gdf = gpd.GeoDataFrame(\n        df, crs=input_crs , geometry=gpd.points_from_xy(df.iloc[:,0], df.iloc[:,1]))\n\n    gdf.to_crs(output_crs, inplace=True)\n    gdf.iloc[:,0] = gdf.geometry.x # replace x\n    gdf.iloc[:,1] = gdf.geometry.y # replace y\n    \n    # export reprojected csv \n    gdf.iloc[:,:-1].to_csv(os.path.join(out_path, file), index=False )\n```\n\nIn the above code, we loop through our CSV files. For each file, we create a GeoDataFrame and change the CRS. Lastly, we replace the coordinates with reprojected one. \n\n### Endnote\n\nThere is another way I found by using **pyproj** library which is quite verbose but performs reprojection on-the-fly. To read about the **pyproj** method, refer [here](https://gis.stackexchange.com/a/168496).\n\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"paged","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"markdown"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"wrap","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true,"format-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["../../_variables.scss"],"toc":true,"output-file":"index.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items"},"metadata":{"lang":"en-GB","fig-responsive":true,"quarto-version":"1.3.450","theme":["sandstone"],"page-layout":"article","fontsize":"1.1em","linestretch":1.7,"fontcolor":"black","author":[{"id":"cvc","number":1,"name":{"given":"Aman","family":"Bagrecha","literal":"Aman Bagrecha","non-dropping-particle":"von"},"orcid":"0000-0003-3131-0864","email":"jainaman588@gmail.com"}],"mermaid":{"theme":"neutral"},"title":"Two ways to Programmatically change projection of raw CSV","date":"2021-09-30","slug":"two-ways-to-change-projection-of-raw-csv","categories":["GDAL","Python"],"tags":["GDAL","Python"],"subtitle":"","description":"Change projection of CSV on-the-fly using GDAL, GeoPandas","lastmod":"2021-10-10T18:42:47+05:30","featured":"no","projects":[]},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}