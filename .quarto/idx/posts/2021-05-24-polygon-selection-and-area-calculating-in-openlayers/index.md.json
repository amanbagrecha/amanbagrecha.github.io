{"title":"Polygon Selection and  Area Calculation in Openlayers","markdown":{"yaml":{"title":"Polygon Selection and  Area Calculation in Openlayers","date":"2021-05-24","slug":"polygon-selection-and-area-calculation-in-openlayers","categories":["OpenLayers"],"tags":[],"subtitle":"","description":"Select multiple polygons (parcels) and calculate area on the fly in openlayers"},"headingText":"**Overview**","containsRefs":false,"markdown":"\n\nIn this small demo-blog we look into how to make polygon selections on the map and calculate the area of that polygon on-the-fly. We use openlayers v6 for client side and geoserver to save our vector layers for this exercise.  \nI assume readers to have familiarity with setting up geoserver and basics of openlayers.\n\n## **Step 1: Setup openlayers** \nOpenlayers requires you to add these cdns to add their functionality into our application.\n### link necessary cdns\n```html\n\n <link rel=\"stylesheet\" href=\"https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/css/ol.css\" type=\"text/css\">\n <script src=\"https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/build/ol.js\"></script>\n \n```\n\n\nWe are using openlayers to render the request response. since the output of the WFS request is json, we create a new layer with vector source and format as geojson. \nThe `strategy:ol.loadingstrategy.bbox` tells openlayers to only load features within the bbox. Simply put, if we move to different location, only features within that bbox will appear.\n\n```javascript\n\n// setup geoserver port\nvar geoserver_ip = 'http://120.0.0.1'\nvar geoserver_port = '8080'\n\n// define vector source\nvar myFlSource = new ol.source.Vector({\n\tformat: new ol.format.GeoJSON(),\n\t\turl: function (extent){\n\t\t\treturn ( geoserver_ip +':' + geoserver_port + '/geoserver/dronnav/ows?service=WFS&version=1.1.0&request=GetFeature&typeName=dronnav%3Aflorida_bp&maxFeatures=10000&outputFormat=application/json&srsname=EPSG:4326&' + 'bbox=' + extent.join(',') + ',EPSG:4326' );\n\t\t},\n\t\tstrategy:ol.loadingstrategy.bbox,\n\t});\n```\n\n\nWe perform WFS request from geoserver to get our layer `florida_bp` in this case. The parameters are as explained as follows\n\n- `service=WFS` : web feature service to perform interaction\n\n- `typename=workspace:florida_bp` : specify the workspace and layer name\n\n- `version=1.1.0` : version number\n\n- `maxFeatures = 10000` : since WFS request is computationaly expensive, we restrict to only load 10000 features.\n\n- `request=GetFeature` : request type. There are several other which can be found here\n\n-  `outputFormat=application/json` : the output format as response\n\n- `srsname=EPSG:4326` : coordinate reference system to display on the map\n\n- `bbox=` : bounding box\n\n\n```javascript\n// define vector layer\nvar floridaLayer = new ol.layer.Vector({\n\tsource: myFlSource,\n\tstyle: new ol.style.Style({\n\t\tfill: new ol.style.Fill({\n\t\t\tcolor: 'rgba(1, 1, 255, .2)',\n\t\t\t}),\n\t\tstroke: new ol.style.Stroke({\n\t\t\tcolor: 'rgba(1, 1, 255, .5)',\n\t\t\twidth: 2,\n\t\t}),\n\t\t}),\n\t\tminZoom: 16, // this will allows us to send request only when the zoom is atleast 16\n});\n```\n\nOnce the layer is defined, we need to add this layer to the map. We can either use `map.addLayer(layername)` or add to array in the map (`Fig.1`)\n```javascript\n// add ESRI basemap\nvar project_maplayer =    new ol.layer.Tile({\n\tsource: new ol.source.XYZ({\n\t\tattributions: ['Powered by Esri',\n\t\t\t\t\t\t\t\t\t\t'Source: Esri, DigitalGlobe, GeoEye, Earthstar Geographics, CNES/Airbus DS, USDA, USGS, AeroGRID, IGN, and the GIS User Community'],\n\t\tattributionsCollapsible: false,\n\t\turl: 'https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',\n\t\tmaxZoom: 23\n\t}),\n\tzIndex: 0\n});\n\n// add view with projection set to EPSG 4326 for the map\nvar project_view = new ol.View({\n\tprojection: 'EPSG:4326',\n\tcenter: [-81.80808208706726, 27.285095000261222],\n\tzoom: 7,\n});\n\n// define the map with all the layers created previously\nvar Projectmap = new ol.Map({\n\tlayers: [project_maplayer, floridaLayer],\n\toverlays: [overlay],\n\ttarget: 'project_map', // the div element `id` in html page\n\tview: project_view,\n});\n```\n\n<figure>\n\n![](https://i.imgur.com/jodNbPQ.jpg)\n\n<figcaption align = \"center\"><b><i>Fig.1 -The Map layer with building footprints (<code>floridaLayer</code>) added to the map with the style we specified</code> for each feature</i></b></figcaption>\n\n</figure>\n\n\n\n## **Get feature info on click**\n\nAfter adding basemap and our layer to the map served via geoserver, we are now ready to get information `on-click`. We use  `forEachFeatureAtPixel` method on our layer to send a WFS request to our geoserver and recive a response in json format. We change the style of the building on click (`Fig.2`). The area is calculated using formatArea function which utilises `ol.sphere.getArea` and `transform` method to calculate area and change CRS.\n\n```javascript\n\n  /*  select ploygon the feature and get area and store the features */\n  var selected = []; // contains all features\n  var selected_area = []; // contains area of feature, one-to-one\n  \n  Projectmap.on('singleclick', function (e) {\n  Projectmap.forEachFeatureAtPixel(e.pixel, function (f, l) {\n  \tvar mycoordinate = e.coordinate\n  \tstoref = f  // feature\n  \t/* if click is on polygon, then select the feature */\n  if ( f.getGeometry()   instanceof  ol.geom.MultiPolygon ) {\n\t\t  \n\t\tvar selIndex = selected.indexOf(f);\n\t\t\t// console.log(selIndex)\n\t\tif (selIndex < 0) {\n\t\t\tselected.push(f);\n\t\t\tselected_area.push( formatArea(f) ); // formatArea function returns the area in ft2\n\t\t\tf.setStyle(highlightStyle); // change style on click\n\t\t} else {\n\t\t\tselected.splice(selIndex, 1);\n\t\t\tselected_area.splice( selIndex, 1);\n\t\t\tf.setStyle(undefined);\n\t\t}\n \t }\n\n\t  })\n\n\t  /* update the tags with no of selected feature and total area combined */\n\t  document.getElementById('status-selected').innerHTML = '&nbsp;' + selected.length + ' selected features';\n\t  document.getElementById('status-selected_area').innerHTML = '&nbsp;' + selected_area.reduce(getSum, 0) + ' ft<sup>2</sup>';\n\t  \n\t});\n\t\n\n\t\n  /* style for selected feature on click  */\n  var highlightStyle = new ol.style.Style({\n  \tfill: new ol.style.Fill({\n  \tcolor: '#f0b88b',\n  \t}),\n  \tstroke: new ol.style.Stroke({\n  \tcolor: '#f0b88b',\n  \twidth: 3,\n  \t}),\n  });\n\n\n  /*  function for calculating area of the polygon (feature) selected */\n  function formatArea (polygon){\n   var area = ol.sphere.getArea(polygon.getGeometry().transform('EPSG:4326', 'EPSG:3857')); // transform to projected coordinate system.\n   var output;\n   output = Math.round(area * 100*10.7639) / 100  ; //in ft2\n   polygon.getGeometry().transform('EPSG:3857', 'EPSG:4326' ) //convert back to geographic crc\n   return output;\n  }\n  \n  /*  function for array sum */\n  function getSum(total, num) {\n  return total + Math.round(num);\n  }\n\n```\n\n<figure>\n\n![](https://i.imgur.com/TCicCHu.jpg)\n\n<figcaption align = \"center\"><b><i>Fig.2 -The <code>floridaLayer</code> building footprints selected  with the style we specified</code> for each feature</i></b></figcaption>\n\n</figure>\n\n\n## **Final comments**\nThis post demonstrates the use of `strategy:ol.loadingstrategy.bbox` to load only the features that cover the bounding box. We use this strategy since WFS service is resouce intensive and our server cannot handle millions of HTTP request at once.\n\nWe also see the use of `forEachFeatureAtPixel` method to select our building footprints. On click of the feature we change the style using `setStyle` method.\n\nAdditionally, we saw how to change projection on-the-fly using `ol.sphere.getArea` method. A word of caution while using `EPSG:3857`. My AOI was on the equator and thus calculating area does not result in significant error. But if the AOI is in temperate zone then adopt suitable projection CRS.\n\n\nLayer Credit: Microsoft buidling footprints https://github.com/microsoft/USBuildingFootprints\n","srcMarkdownNoYaml":"\n\n## **Overview**\nIn this small demo-blog we look into how to make polygon selections on the map and calculate the area of that polygon on-the-fly. We use openlayers v6 for client side and geoserver to save our vector layers for this exercise.  \nI assume readers to have familiarity with setting up geoserver and basics of openlayers.\n\n## **Step 1: Setup openlayers** \nOpenlayers requires you to add these cdns to add their functionality into our application.\n### link necessary cdns\n```html\n\n <link rel=\"stylesheet\" href=\"https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/css/ol.css\" type=\"text/css\">\n <script src=\"https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/build/ol.js\"></script>\n \n```\n\n\nWe are using openlayers to render the request response. since the output of the WFS request is json, we create a new layer with vector source and format as geojson. \nThe `strategy:ol.loadingstrategy.bbox` tells openlayers to only load features within the bbox. Simply put, if we move to different location, only features within that bbox will appear.\n\n```javascript\n\n// setup geoserver port\nvar geoserver_ip = 'http://120.0.0.1'\nvar geoserver_port = '8080'\n\n// define vector source\nvar myFlSource = new ol.source.Vector({\n\tformat: new ol.format.GeoJSON(),\n\t\turl: function (extent){\n\t\t\treturn ( geoserver_ip +':' + geoserver_port + '/geoserver/dronnav/ows?service=WFS&version=1.1.0&request=GetFeature&typeName=dronnav%3Aflorida_bp&maxFeatures=10000&outputFormat=application/json&srsname=EPSG:4326&' + 'bbox=' + extent.join(',') + ',EPSG:4326' );\n\t\t},\n\t\tstrategy:ol.loadingstrategy.bbox,\n\t});\n```\n\n\nWe perform WFS request from geoserver to get our layer `florida_bp` in this case. The parameters are as explained as follows\n\n- `service=WFS` : web feature service to perform interaction\n\n- `typename=workspace:florida_bp` : specify the workspace and layer name\n\n- `version=1.1.0` : version number\n\n- `maxFeatures = 10000` : since WFS request is computationaly expensive, we restrict to only load 10000 features.\n\n- `request=GetFeature` : request type. There are several other which can be found here\n\n-  `outputFormat=application/json` : the output format as response\n\n- `srsname=EPSG:4326` : coordinate reference system to display on the map\n\n- `bbox=` : bounding box\n\n\n```javascript\n// define vector layer\nvar floridaLayer = new ol.layer.Vector({\n\tsource: myFlSource,\n\tstyle: new ol.style.Style({\n\t\tfill: new ol.style.Fill({\n\t\t\tcolor: 'rgba(1, 1, 255, .2)',\n\t\t\t}),\n\t\tstroke: new ol.style.Stroke({\n\t\t\tcolor: 'rgba(1, 1, 255, .5)',\n\t\t\twidth: 2,\n\t\t}),\n\t\t}),\n\t\tminZoom: 16, // this will allows us to send request only when the zoom is atleast 16\n});\n```\n\nOnce the layer is defined, we need to add this layer to the map. We can either use `map.addLayer(layername)` or add to array in the map (`Fig.1`)\n```javascript\n// add ESRI basemap\nvar project_maplayer =    new ol.layer.Tile({\n\tsource: new ol.source.XYZ({\n\t\tattributions: ['Powered by Esri',\n\t\t\t\t\t\t\t\t\t\t'Source: Esri, DigitalGlobe, GeoEye, Earthstar Geographics, CNES/Airbus DS, USDA, USGS, AeroGRID, IGN, and the GIS User Community'],\n\t\tattributionsCollapsible: false,\n\t\turl: 'https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',\n\t\tmaxZoom: 23\n\t}),\n\tzIndex: 0\n});\n\n// add view with projection set to EPSG 4326 for the map\nvar project_view = new ol.View({\n\tprojection: 'EPSG:4326',\n\tcenter: [-81.80808208706726, 27.285095000261222],\n\tzoom: 7,\n});\n\n// define the map with all the layers created previously\nvar Projectmap = new ol.Map({\n\tlayers: [project_maplayer, floridaLayer],\n\toverlays: [overlay],\n\ttarget: 'project_map', // the div element `id` in html page\n\tview: project_view,\n});\n```\n\n<figure>\n\n![](https://i.imgur.com/jodNbPQ.jpg)\n\n<figcaption align = \"center\"><b><i>Fig.1 -The Map layer with building footprints (<code>floridaLayer</code>) added to the map with the style we specified</code> for each feature</i></b></figcaption>\n\n</figure>\n\n\n\n## **Get feature info on click**\n\nAfter adding basemap and our layer to the map served via geoserver, we are now ready to get information `on-click`. We use  `forEachFeatureAtPixel` method on our layer to send a WFS request to our geoserver and recive a response in json format. We change the style of the building on click (`Fig.2`). The area is calculated using formatArea function which utilises `ol.sphere.getArea` and `transform` method to calculate area and change CRS.\n\n```javascript\n\n  /*  select ploygon the feature and get area and store the features */\n  var selected = []; // contains all features\n  var selected_area = []; // contains area of feature, one-to-one\n  \n  Projectmap.on('singleclick', function (e) {\n  Projectmap.forEachFeatureAtPixel(e.pixel, function (f, l) {\n  \tvar mycoordinate = e.coordinate\n  \tstoref = f  // feature\n  \t/* if click is on polygon, then select the feature */\n  if ( f.getGeometry()   instanceof  ol.geom.MultiPolygon ) {\n\t\t  \n\t\tvar selIndex = selected.indexOf(f);\n\t\t\t// console.log(selIndex)\n\t\tif (selIndex < 0) {\n\t\t\tselected.push(f);\n\t\t\tselected_area.push( formatArea(f) ); // formatArea function returns the area in ft2\n\t\t\tf.setStyle(highlightStyle); // change style on click\n\t\t} else {\n\t\t\tselected.splice(selIndex, 1);\n\t\t\tselected_area.splice( selIndex, 1);\n\t\t\tf.setStyle(undefined);\n\t\t}\n \t }\n\n\t  })\n\n\t  /* update the tags with no of selected feature and total area combined */\n\t  document.getElementById('status-selected').innerHTML = '&nbsp;' + selected.length + ' selected features';\n\t  document.getElementById('status-selected_area').innerHTML = '&nbsp;' + selected_area.reduce(getSum, 0) + ' ft<sup>2</sup>';\n\t  \n\t});\n\t\n\n\t\n  /* style for selected feature on click  */\n  var highlightStyle = new ol.style.Style({\n  \tfill: new ol.style.Fill({\n  \tcolor: '#f0b88b',\n  \t}),\n  \tstroke: new ol.style.Stroke({\n  \tcolor: '#f0b88b',\n  \twidth: 3,\n  \t}),\n  });\n\n\n  /*  function for calculating area of the polygon (feature) selected */\n  function formatArea (polygon){\n   var area = ol.sphere.getArea(polygon.getGeometry().transform('EPSG:4326', 'EPSG:3857')); // transform to projected coordinate system.\n   var output;\n   output = Math.round(area * 100*10.7639) / 100  ; //in ft2\n   polygon.getGeometry().transform('EPSG:3857', 'EPSG:4326' ) //convert back to geographic crc\n   return output;\n  }\n  \n  /*  function for array sum */\n  function getSum(total, num) {\n  return total + Math.round(num);\n  }\n\n```\n\n<figure>\n\n![](https://i.imgur.com/TCicCHu.jpg)\n\n<figcaption align = \"center\"><b><i>Fig.2 -The <code>floridaLayer</code> building footprints selected  with the style we specified</code> for each feature</i></b></figcaption>\n\n</figure>\n\n\n## **Final comments**\nThis post demonstrates the use of `strategy:ol.loadingstrategy.bbox` to load only the features that cover the bounding box. We use this strategy since WFS service is resouce intensive and our server cannot handle millions of HTTP request at once.\n\nWe also see the use of `forEachFeatureAtPixel` method to select our building footprints. On click of the feature we change the style using `setStyle` method.\n\nAdditionally, we saw how to change projection on-the-fly using `ol.sphere.getArea` method. A word of caution while using `EPSG:3857`. My AOI was on the equator and thus calculating area does not result in significant error. But if the AOI is in temperate zone then adopt suitable projection CRS.\n\n\nLayer Credit: Microsoft buidling footprints https://github.com/microsoft/USBuildingFootprints\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"paged","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"markdown"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"wrap","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true,"format-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["../../_variables.scss"],"toc":true,"output-file":"index.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items"},"metadata":{"lang":"en-GB","fig-responsive":true,"quarto-version":"1.3.450","theme":["sandstone"],"page-layout":"article","fontsize":"1.1em","linestretch":1.7,"fontcolor":"black","author":[{"id":"cvc","number":1,"name":{"given":"Aman","family":"Bagrecha","literal":"Aman Bagrecha","non-dropping-particle":"von"},"orcid":"0000-0003-3131-0864","email":"jainaman588@gmail.com"}],"mermaid":{"theme":"neutral"},"title":"Polygon Selection and  Area Calculation in Openlayers","date":"2021-05-24","slug":"polygon-selection-and-area-calculation-in-openlayers","categories":["OpenLayers"],"tags":[],"subtitle":"","description":"Select multiple polygons (parcels) and calculate area on the fly in openlayers"},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}