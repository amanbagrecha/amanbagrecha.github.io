{"title":"Polygonize Raster and Compute Zonal-Statistics in Python","markdown":{"yaml":{"title":"Polygonize Raster and Compute Zonal-Statistics in Python","date":"2021-09-30","slug":"polygonize-raster-and-compute-zonal-stats-in-python","categories":["GDAL","Python"],"tags":["GDAL","Python"],"subtitle":"","description":"Computing zonal statistics over raster using GDAL and Python","authors":[],"lastmod":"2021-10-09T18:51:08+05:30","featured":"no","projects":[]},"headingText":"code to polygonize using rasterio","containsRefs":false,"markdown":"\n\nThe output of a clustering algorithm is a raster. But when you want to compute statistics of the clustered raster, it needs to be polygonized.  \n \n\nA simple way to perform this action is using the gdal command line `gdal_polygonize.py` script. This script requires the output file format, input raster file and output name of the vector file. You can additionally mask pixel values which you don't want to convert to polygons. For this example, we would consider a single band image.\n\n\n```shell\npython gdal_polygonize.py raster_file -f \"ESRI Shapefile\" vector_file.shp  layername atrributefieldname\n```\n`--nomask` allows to include nodata values in the shapefile\n\n`atrributefieldname` should always be preceded with `layername` else it would result in an error.\n\nThe output would result in a vector layer. The number of output polygons is equal to the number of non-NA values. Each neighbouring cell (pixel) which is connected in the raster having the same value is combined to form a single polygon.\n\nFor instance, consider this 4 x 4 raster. When converted to vector, it resulted in 6 polygons. Note that disconnected similar values form an independent polygon. Each polygon will have an attribute as its pixel value from the raster, in the data type of the image. These would end up being a pair of (polygon, value) for each feature found in the image.\n\n\n<figure>\n\n![](https://i.imgur.com/xeJ4BGa.png)\n<figcaption align = \"center\"><b><i>Fig.1 -Converting Raster to Vector using GDAL. The output polygon has attribute associated with its raster value </i></b></figcaption>\n\n</figure>\n\n\nAnother way to polygonize raster programmatically is to use the `rasterio` library. Since rasterio utilizes GDAL under the hood, it also performs similar action and results in a pair of geometry and raster value. We create a tuple of dictionaries to store each feature output.\n\n\n```python\nfrom rasterio import features\n\n# read the raster and polygonize\nwith rasterio.open(cluster_image_path) as src:\n    image = src.read(1, out_dtype='uint16') \n    #Make a mask!\n    mask = image != 0\n# `results` contains a tuple. With each element in the tuple representing a dictionary containing the feature (polygon) and its associated raster value\nresults = ( {'properties': {'cluster_id': int(v)}, 'geometry': s} \n            for (s, v) in (features.shapes(image, mask=mask, transform=src.transform)))\n```\n\nOnce we have the raster polygonized, we can use `rasterstats` library to calculate zonal statistics. We use this library since there is no in-built functionality for rasterio to calculate it.\n\nThis library has a function `zonal_stats` which takes in a vector layer and a raster to calculate the zonal statistics. Read more [here](https://pythonhosted.org/rasterstats/manual.html#zonal-statistics) \n\nThe parameters to the function are:\n\n1. vectors: path to an vector source or geo-like python objects\n2. raster: ndarray or path to a GDAL raster source\n\nand various other options which can be found [here](https://github.com/perrygeo/python-rasterstats/blob/master/src/rasterstats/main.py#L34) \n\nTo create a vector layer from the tuple `results`, we use geopandas. There are other libraries (such as fiona) which can also create vector geometry from shapely objects. \n\nFor raster, we pass the `.tif` file directly to `zonal_stats`. The final code looks like the following\n\n\n```python\nfrom rasterstats import zonal_stats\n\nin_shp = gpd.GeoDataFrame.from_features(results).set_crs(crs=src.crs)\n\n# stats parameter takes in various statistics that needs to be computed \nstatistics= zonal_stats(in_shp,image,stats='min, max, mean, median',\n                geojson_out=True, nodata = -999)\n```\nThe output is a geojson generator when `geojson_out` is True. we can convert the geojson to dataframe and export as csv for further processing.\n\n\nThis way, with the help of geopandas, rasterstats and rasterio, we polygonize the raster and calculate zonal statistics.\n","srcMarkdownNoYaml":"\n\nThe output of a clustering algorithm is a raster. But when you want to compute statistics of the clustered raster, it needs to be polygonized.  \n \n\nA simple way to perform this action is using the gdal command line `gdal_polygonize.py` script. This script requires the output file format, input raster file and output name of the vector file. You can additionally mask pixel values which you don't want to convert to polygons. For this example, we would consider a single band image.\n\n\n```shell\npython gdal_polygonize.py raster_file -f \"ESRI Shapefile\" vector_file.shp  layername atrributefieldname\n```\n`--nomask` allows to include nodata values in the shapefile\n\n`atrributefieldname` should always be preceded with `layername` else it would result in an error.\n\nThe output would result in a vector layer. The number of output polygons is equal to the number of non-NA values. Each neighbouring cell (pixel) which is connected in the raster having the same value is combined to form a single polygon.\n\nFor instance, consider this 4 x 4 raster. When converted to vector, it resulted in 6 polygons. Note that disconnected similar values form an independent polygon. Each polygon will have an attribute as its pixel value from the raster, in the data type of the image. These would end up being a pair of (polygon, value) for each feature found in the image.\n\n\n<figure>\n\n![](https://i.imgur.com/xeJ4BGa.png)\n<figcaption align = \"center\"><b><i>Fig.1 -Converting Raster to Vector using GDAL. The output polygon has attribute associated with its raster value </i></b></figcaption>\n\n</figure>\n\n\nAnother way to polygonize raster programmatically is to use the `rasterio` library. Since rasterio utilizes GDAL under the hood, it also performs similar action and results in a pair of geometry and raster value. We create a tuple of dictionaries to store each feature output.\n\n\n```python\n# code to polygonize using rasterio\nfrom rasterio import features\n\n# read the raster and polygonize\nwith rasterio.open(cluster_image_path) as src:\n    image = src.read(1, out_dtype='uint16') \n    #Make a mask!\n    mask = image != 0\n# `results` contains a tuple. With each element in the tuple representing a dictionary containing the feature (polygon) and its associated raster value\nresults = ( {'properties': {'cluster_id': int(v)}, 'geometry': s} \n            for (s, v) in (features.shapes(image, mask=mask, transform=src.transform)))\n```\n\nOnce we have the raster polygonized, we can use `rasterstats` library to calculate zonal statistics. We use this library since there is no in-built functionality for rasterio to calculate it.\n\nThis library has a function `zonal_stats` which takes in a vector layer and a raster to calculate the zonal statistics. Read more [here](https://pythonhosted.org/rasterstats/manual.html#zonal-statistics) \n\nThe parameters to the function are:\n\n1. vectors: path to an vector source or geo-like python objects\n2. raster: ndarray or path to a GDAL raster source\n\nand various other options which can be found [here](https://github.com/perrygeo/python-rasterstats/blob/master/src/rasterstats/main.py#L34) \n\nTo create a vector layer from the tuple `results`, we use geopandas. There are other libraries (such as fiona) which can also create vector geometry from shapely objects. \n\nFor raster, we pass the `.tif` file directly to `zonal_stats`. The final code looks like the following\n\n\n```python\nfrom rasterstats import zonal_stats\n\nin_shp = gpd.GeoDataFrame.from_features(results).set_crs(crs=src.crs)\n\n# stats parameter takes in various statistics that needs to be computed \nstatistics= zonal_stats(in_shp,image,stats='min, max, mean, median',\n                geojson_out=True, nodata = -999)\n```\nThe output is a geojson generator when `geojson_out` is True. we can convert the geojson to dataframe and export as csv for further processing.\n\n\nThis way, with the help of geopandas, rasterstats and rasterio, we polygonize the raster and calculate zonal statistics.\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"paged","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"markdown"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"wrap","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true,"format-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["../../_variables.scss"],"toc":true,"output-file":"index.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items"},"metadata":{"lang":"en-GB","fig-responsive":true,"quarto-version":"1.3.450","theme":["sandstone"],"page-layout":"article","fontsize":"1.1em","linestretch":1.7,"fontcolor":"black","author":[{"id":"cvc","number":1,"name":{"given":"Aman","family":"Bagrecha","literal":"Aman Bagrecha","non-dropping-particle":"von"},"orcid":"0000-0003-3131-0864","email":"jainaman588@gmail.com"}],"mermaid":{"theme":"neutral"},"title":"Polygonize Raster and Compute Zonal-Statistics in Python","date":"2021-09-30","slug":"polygonize-raster-and-compute-zonal-stats-in-python","categories":["GDAL","Python"],"tags":["GDAL","Python"],"subtitle":"","description":"Computing zonal statistics over raster using GDAL and Python","authors":[],"lastmod":"2021-10-09T18:51:08+05:30","featured":"no","projects":[]},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}