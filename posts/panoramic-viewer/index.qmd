---
title: Panoramic Image Editing & Reconstruction Pipeline
date: 2025-12-05
date-modified: last-modified
slug: panoramic-viewer
categories:
- visualization
- computer-vision
tags: [panorama, '360', viewer, image-editing, inpainting]
description: 'Using AI for editing and inpainting high resolution 360° panoramic imagery'
draft: true
reading-time: yes
image: original.webp
image-alt: 'inpainting streetview panoramic imagery'
url_code: "https://github.com/amanbagrecha/comfyui-workflow-docker"
resources:
  - panorama.jpg
  - before.png
  - after.png
  - workflow.webp
  - original.webp
format:
  html:
    toc: false
    include-in-header:
      - text: |
          <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css"/>
          <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>
---

::: {.callout-note icon=false}
## Source Code
The complete ComfyUI workflow and Docker setup for this project is available on GitHub: [comfyui-workflow-docker](https://github.com/amanbagrecha/comfyui-workflow-docker)
:::


Over the past month, I have been building a pipeline for editing panoramic (360° equirectangular) imagery, similar to how google streetview cleans up its imagery. More specifically - I wanted to make my image visually appealing without loosing the quality and resolution of the image.

![Original Panoramic Images with artifacts](original.webp)
> original equirectangular image with artifacts in car and sky glare (marked with red arrows in the image)

My task in this fun project was to remove artifacts (a car captured in the 360-degree view and sky glare) from the scene. The problem is that these panoramic scenes are large, and traditional [LaMa](https://github.com/advimman/lama) inpainting models do not work well for large object removal.


To tackle this, I initially thought of segmenting the road using Segment Anything model and regenerating a new road (using an image editing model) as a replacement, and doing the same process for the sky. But there are many ifs and buts in that approach:

  - if road detection is poor and can lead to over/under prediction, causing seams and abrupt changes

  - glare from the camera blocks the full view

  - object obstruction makes replacement difficult

Also, any of these inpainting models (from [SDXL](https://huggingface.co/stabilityai/stable-diffusion-xl-base-1.0) / [Flux](https://huggingface.co/black-forest-labs/FLUX.1-dev) / [Fooocus](https://github.com/lllyasviel/Fooocus)) were not made for very high-resolution imagery.

Additionally, the challenge with panoramic imagery is that editing in equirectangular projection introduces distortions, edge-wrap artifacts, and inconsistent geometry. I saw firsthand that changing the sky using any generative model introduces seams at the edges (the left and right images are not continuous after the edit).

That is when I thought of using the following tricks to get around the bottlenecks. I built a structured workflow that extracts clean perspective views, edits them using generative models (Qwen Image Edit 2509 in this case), and then maps the edits back accurately into the original panorama.

![Workflow Diagram](workflow.webp)



### Extract Perspective Views

I used `pytorch360convert` to extract targeted perspective slices from the 360° image.

I ensured the Field of View was wide enough to capture surrounding context for the model to work -
- since in this view the car was visible along with front and back of the road (enough context for the model)
- the sky artifact also had surrounding region to infer from for inpainting the region. 


These perspective slices provided a geometrically accurate view of localized regions—particularly useful when removing objects and artifacts like cars or cleaning up the sky.

I also generated a mask (manually created) for the unwanted object (in this case the car and sky). Since these are stationary throughout, it was easier to manually make the binary mask.


### Object Removal Pipeline Using Qwen Image Edit 2509

I ran the Qwen Image Edit 2509 model on the two separate tasks - one for car inpainting and other for sky regeneration. The workflow was:

For Car:

1. Create a perspective Image+mask composite to hide only the car to inpaint, which avoids altering any other part of the image. This was crucial as Qwen model doesn't allow to pass in a mask, but rather you can mask in other image (which I did not want to do) 

2. Run the perspective slice through Qwen Image Edit 2509 with a prompt to remove the masked car.

For sky:

1. Create a 1024x1024 resized image (with padding at top and bottom) - such that the actual pixels of image are only at 1024x512. This was again critical to avoid the problem of [offset/zoom](https://www.reddit.com/r/StableDiffusion/comments/1o01e6i/totally_fixed_the_qwenimageedit2509_unzooming/) that these diffusion models face.  

2. Run the 1024x1024 px through Qwen Image Edit 2509 with a prompt to replace the sky with bright sunny clear day.

### Before/After Comparison Slider

```{=html}
<div style="position: relative; width: 100%; max-width: 1024px; margin: 0 auto; overflow: hidden; border: 1px solid #ddd;">
  <img id="imageBefore" src="before.png" style="display: block; width: 100%; height: auto;">
  <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; clip-path: inset(0 0 0 50%);" id="afterContainer">
    <img id="imageAfter" src="after.png" style="display: block; width: 100%; height: auto;">
  </div>
  <div id="sliderHandle" style="position: absolute; left: 50%; top: 0; bottom: 0; width: 4px; background: white; cursor: ew-resize; z-index: 1000; box-shadow: 0 0 10px rgba(0,0,0,0.5);"></div>
</div>

The inpainting is pixel perfect with no offset while maintaining structural consistency.
```

### Forward Mapping (Perspective -> equirectangular image)

Since editing happens in perspective space, I needed to convert edited pixels back into the original equirectangular space.

To ensure perfect geometric alignment, I built a per-pixel forward map, mimicking pytorch360convert's sampling behavior.  There was no existing code for this forward mapping available online, so I had to build this one myself and the code for this project is now a ComfyUI node which can be found [here](https://github.com/amanbagrecha/p2e).



### Merge the Edited Perspective Patch

Once the edit is done, I use the precomputed forward map to scatter updated pixels onto the original panorama. I applied a slight feather at the edge to blend. This method gave smooth, artifact-free transitions without visible seams.


---------------

So till this point, we just removed the car from the scene, now the sky had to be replaced.

### 5. Segmentation and Lama

As mentioned above, I used Qwen to replace the sky on a low resolution image. The problem was now to replace on the original scene, since I did not want to lose the high-resolution details from the entire scene.

To this end, I used SAM3, which offered prompt based Segmentation - perfect for my use case. More so, because it did very well in a variety of different lighting conditions. And I could also prompt "glare" and get the segments for that as well.

This allowed me to get a good segment and replace it (after upsampling to the original scene size). The only other concern was seam at the edges and black artifacts due to camera capture.

I used [LAMA](https://github.com/advimman/lama) to inpaint this as it was a small and stationary spot. Though it required generating a perspective image and then perform the edit. For seam removal, I applied a thin blending at edges after rolling the image and bringing it to the center.
As post-processing step I EgoBlur model to blur faces and License Plates similar to how things are done in google streetview



### ComfyUI API Workflow

The entire process mentioned above was tested and built on ComfyUI workflow to match my requirements for this project. It was a lot of trial and error to make this work. The workflow json can be found [here](https://github.com/amanbagrecha/comfyui-workflow-docker/blob/master/workflow-updated.json)

The end result is original image quality, but visually appealing. I used to wonder how is generative AI of any use - but this project helped me find value in such technology. I am amazed with what open source models could accompolish, provided you navigate the messy documentation and scattered literature


---

### Interactive 360° Panoramic Viewer

<div id="panorama" style="width: 100%; height: 500px;"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    pannellum.viewer('panorama', {
        "type": "equirectangular",
        "panorama": "./panorama.jpg",
        "autoLoad": true,
        "showZoomCtrl": true,
        "showFullscreenCtrl": true,
        "mouseZoom": true,
        "draggable": true
    });
});
</script>

The final result after inpainting and reconstruction. Click and drag to explore the 360° view. Use the mouse wheel to zoom in and out.

---

*The above process is computationally expensive. I ran the FP8 version on a L40S system having 48 GB VRAM. The time it takes for one entire run is about 20 sec.
The models are heavy in size (total of about 20GB) which were downloaded from huggingface. I did find another repository which bundled all the weights into one - called [RAPID AIO](https://huggingface.co/Phr00t/Qwen-Image-Edit-Rapid-AIO), but it seem to have a offset issue.
*


### Links

1. [Core Qwen / Model References](https://docs.comfy.org/tutorials/image/qwen/qwen-image-edit)

2. [Vehicle and Number Plate Removal](https://github.com/facebookresearch/EgoBlur)

3. [Simple Inpainting (LaMa)](https://github.com/advimman/lama)

4. [Equirectangular → Perspective](https://github.com/ProGamerGov/pytorch360convert)

5. [Perspective → Equirectangular](https://github.com/amanbagrecha/p2e)

6. [SAM3 segmentation](https://github.com/facebookresearch/sam3)


### Models Used

- **Text Encoder**: Qwen 2.5 VL 7B (FP8)
- **VAE**: Qwen Image VAE
- **LoRA**: Qwen Image Edit Lightning (4-step)
- **Upscaler**: Real-ESRGAN x2
- **Diffusion Model**: Qwen Image Edit 2509 (FP8)
- **SAM3**: Segment Anything Model 3
- **EgoBlur Face**: Face detection model
- **EgoBlur License Plate**: License plate detection model


<script>
let isDragging = false;

const sliderHandle = document.getElementById('sliderHandle');
const afterContainer = document.getElementById('afterContainer');
const container = sliderHandle.parentElement;

function startDragging(e) {
    isDragging = true;
    e.preventDefault();
}

function handleDrag(e) {
    if (!isDragging) return;

    const rect = container.getBoundingClientRect();
    const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
    let x = clientX - rect.left;
    x = Math.max(0, Math.min(x, rect.width));

    const percentage = (x / rect.width) * 100;
    sliderHandle.style.left = percentage + '%';
    afterContainer.style.clipPath = `inset(0 0 0 ${percentage}%)`;
}

function stopDragging() {
    isDragging = false;
}

// Mouse events
sliderHandle.addEventListener('mousedown', startDragging);
document.addEventListener('mousemove', handleDrag);
document.addEventListener('mouseup', stopDragging);

// Touch events for mobile
sliderHandle.addEventListener('touchstart', startDragging);
document.addEventListener('touchmove', handleDrag);
document.addEventListener('touchend', stopDragging);
</script>
